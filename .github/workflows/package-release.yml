name: "[Package] NPM Release"

on:
  workflow_dispatch:
    inputs:
      package:
        type: choice
        description: Package to release
        options:
          - dev-configs
          - core
          - helpers
          - inversion
          - docs
        required: true
      build_mode:
        type: choice
        description: |
          Build Mode
          (patch | minor | major | pre<patch | minor | major | release>)
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
        required: true
        default: 'patch'

env:
  PACKAGE: ${{ github.event.inputs.package }}
  BUILD_MODE: ${{ github.event.inputs.build_mode }}

jobs:
  build-release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      - name: Setup Git
        run: |
          git config user.name "venizia-ci"
          git config user.email "developer@venizia.ai"

      - name: Get package info
        id: pkg_info
        run: |
          PACKAGE_PATH="packages/$PACKAGE"
          PACKAGE_NAME=$(jq -r .name "$PACKAGE_PATH/package.json")
          CURRENT_VERSION=$(jq -r .version "$PACKAGE_PATH/package.json")

          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "PACKAGE_PATH=$PACKAGE_PATH" >> $GITHUB_ENV

          echo "[pkg_info] Package: $PACKAGE_NAME"
          echo "[pkg_info] Path: $PACKAGE_PATH"
          echo "[pkg_info] Current version: $CURRENT_VERSION"

      - name: Verify build mode
        run: |
          echo "[verify] Package: $PACKAGE_NAME | Path: $PACKAGE_PATH | Build mode: $BUILD_MODE"

      - name: Install dependencies
        run: |
          echo "[install] Installing dependencies"
          bun install

      - name: Linting application source
        run: |
          bun run --filter "${{ env.PACKAGE_NAME }}" lint

      - name: Build artifact
        run: |
          bun run --filter "${{ env.PACKAGE_NAME }}" rebuild

      - name: Validate build artifacts
        run: |
          cd ${{ env.PACKAGE_PATH }} 

          if [ ! -d "dist" ]; then
            echo "[validate] Error: dist directory not found"
            exit 1
          fi

          if [ ! -f "dist/index.js" ]; then
            echo "[validate] Error: dist/index.js not found"
            exit 1
          fi

          if [ ! -f "dist/index.d.ts" ]; then
            echo "[validate] Error: dist/index.d.ts not found"
            exit 1
          fi

          echo "[validate] Build artifacts validated successfully"

      - name: Version bump
        id: version
        run: |
          cd ${{ env.PACKAGE_PATH }}
          npm cache clean --force
          npm version $BUILD_MODE --no-git-tag-version --workspaces-update=false

          NEW_VERSION=$(jq -r .version package.json)
          TAG_NAME="$PACKAGE-v$NEW_VERSION"

          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

          echo "[version] New version: $NEW_VERSION"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      - name: Commit version change
        id: commit
        run: |
          cd ${{ env.PACKAGE_PATH }} 

          git fetch origin
          git checkout develop
          git pull origin develop

          git add package.json
          git commit -m "chore($PACKAGE): release v${{ env.NEW_VERSION }} [$BUILD_MODE]"

      - name: Push to develop
        id: push_develop
        run: |
          git push origin develop
          echo "[push_develop] Pushed to develop branch"
          echo "IS_PUSHED=true" >> $GITHUB_ENV

      - name: Create and push tag
        id: tag
        run: |
          git tag -a "${{ env.TAG_NAME }}" -m "${{ env.PACKAGE_NAME }} v${{ env.NEW_VERSION }}"
          git push origin "${{ env.TAG_NAME }}"
          echo "IS_CREATED=true" >> $GITHUB_ENV

      - name: Merge to main (stable releases only)
        id: merge_main
        if: ${{ !startsWith(env.BUILD_MODE, 'pre') }}
        run: |
          git checkout main
          git pull origin main
          git merge develop --no-ff -m "chore: merge $PACKAGE v${{ env.NEW_VERSION }} to main"
          git push origin main

          echo "[merge_main] Merged to main branch"
          echo "IS_MERGED=true" >> $GITHUB_ENV

      - name: Publish to NPM
        id: publish
        run: |
          cd ${{ env.PACKAGE_PATH }} 

          npm_tag=$(case $BUILD_MODE in
            patch|minor|major) echo "latest" ;;
            prepatch|preminor|premajor|prerelease) echo "next" ;;
          esac)

          npm publish --access public --tag $npm_tag

          echo "[publish] Successfully published to NPM"
          echo "IS_PUBLISHED=true" >> $GITHUB_ENV
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      - name: Rollback on failure
        if: failure()
        run: |
          echo "[rollback] Starting rollback process"
          cd ${{ env.PACKAGE_PATH }} 

          # Delete tag if created
          if [ "${{ env.IS_CREATED }}" == "true" ]; then
            git push --delete origin "${{ env.TAG_NAME }}" 2>/dev/null || echo "[rollback] Tag not found on remote"
            git tag -d "${{ env.TAG_NAME }}" 2>/dev/null || echo "[rollback] Tag not found locally"
            echo "[rollback] Deleted tag: ${{ env.TAG_NAME }}"
          fi

          # Reset develop branch if pushed
          if [ "${{ env.IS_PUSHED }}" == "true" ]; then
            git checkout develop
            git reset --hard HEAD~1
            git push --force origin develop
            echo "[rollback] Reset develop branch"
          fi

          # Reset main branch if merged
          if [ "${{ env.IS_MERGED }}" == "true" ]; then
            git checkout main
            git reset --hard HEAD~1
            git push --force origin main
            echo "[rollback] Reset main branch"
          fi

          echo "[rollback] Rollback completed"
          echo "[rollback] Note: NPM packages cannot be unpublished automatically"
          if [ "${{ env.IS_PUBLISHED }}" == "true" ]; then
            echo "[rollback] WARNING: Package was published to NPM as ${{ env.PACKAGE_NAME }}@${{ env.NEW_VERSION }}"
            echo "[rollback] You may need to deprecate it manually: npm deprecate ${{ env.PACKAGE_NAME }}@${{ env.NEW_VERSION }} 'Accidental release'"
          fi
