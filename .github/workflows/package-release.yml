name: "[Package] NPM Release"
run-name: "NPM Release | package: ${{ inputs.package }} | build_mode: ${{ inputs.build_mode }}"

on:
  workflow_dispatch:
    inputs:
      package:
        type: choice
        description: Package to release
        options:
          - dev-configs
          - inversion
          - helpers
          - core
          - docs
        required: true
      build_mode:
        type: choice
        description: "Version bump type (patch | minor | major | pre*)"
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
        required: true
        default: "patch"

# =============================================================================
# PACKAGE DEPENDENCY TREE (for reference):
#   dev-configs  → (none)
#   inversion    → dev-configs
#   helpers      → dev-configs, inversion
#   core         → dev-configs, inversion, helpers
#   docs         → dev-configs
#
# SPECIAL CASES:
#   - docs: builds to mcp-server/dist instead of dist
# =============================================================================

env:
  PACKAGE: ${{ github.event.inputs.package }}
  BUILD_MODE: ${{ github.event.inputs.build_mode }}

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      # =========================================================================
      # SETUP
      # =========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: Setup Git
        run: |
          git config user.name "venizia-ci"
          git config user.email "developer@venizia.ai"

      # =========================================================================
      # PACKAGE INFO
      # =========================================================================
      - name: Get package info
        run: |
          PACKAGE_PATH="packages/$PACKAGE"
          PACKAGE_NAME=$(jq -r .name "$PACKAGE_PATH/package.json")
          CURRENT_VERSION=$(jq -r .version "$PACKAGE_PATH/package.json")

          # Set dist directories to validate
          # SPECIAL CASES:
          #   - docs: builds to mcp-server/dist
          #   - inversion: builds to dist/cjs and dist/esm (dual build)
          case $PACKAGE in
            docs)
              DIST_DIRS="mcp-server/dist"
              ;;
            inversion)
              DIST_DIRS="dist/cjs dist/esm"
              ;;
            *)
              DIST_DIRS="dist"
              ;;
          esac

          # Export to environment
          echo "PACKAGE_PATH=$PACKAGE_PATH" >> $GITHUB_ENV
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "DIST_DIRS=$DIST_DIRS" >> $GITHUB_ENV

          # Log info
          echo "┌─────────────────────────────────────────────────"
          echo "│ Package:     $PACKAGE_NAME"
          echo "│ Path:        $PACKAGE_PATH"
          echo "│ Version:     $CURRENT_VERSION"
          echo "│ Build Mode:  $BUILD_MODE"
          echo "│ Dist Dirs:   $DIST_DIRS"
          echo "└─────────────────────────────────────────────────"

      # =========================================================================
      # BUILD
      # =========================================================================
      - name: Install dependencies
        run: |
          echo ">>> Installing dependencies..."
          bun install
          bun run --filter "$PACKAGE_NAME" force-update

      - name: Build workspace dependencies
        run: |
          echo ">>> Building workspace dependencies for: $PACKAGE"
          make dev-configs
          make core

      - name: Lint source code
        run: |
          echo ">>> Linting $PACKAGE_NAME..."
          bun run --filter "$PACKAGE_NAME" lint

      - name: Build package
        run: |
          echo ">>> Building $PACKAGE_NAME..."
          bun run --filter "$PACKAGE_NAME" rebuild

      - name: Validate build artifacts
        run: |
          cd $PACKAGE_PATH

          # Validate each dist directory
          for DIST_DIR in $DIST_DIRS; do
            echo ">>> Validating: $DIST_DIR"

            # Check dist directory exists
            if [ ! -d "$DIST_DIR" ]; then
              echo "ERROR: $DIST_DIR directory not found"
              exit 1
            fi

            # Check required files
            for file in "index.js" "index.d.ts"; do
              if [ ! -f "$DIST_DIR/$file" ]; then
                echo "ERROR: $DIST_DIR/$file not found"
                exit 1
              fi
            done

            echo "    ✓ $DIST_DIR validated"
          done

          echo "✓ All build artifacts validated successfully"

      # =========================================================================
      # VERSION & PUBLISH
      # =========================================================================
      - name: Bump version
        run: |
          cd $PACKAGE_PATH
          npm version $BUILD_MODE --no-git-tag-version --workspaces-update=false

          NEW_VERSION=$(jq -r .version package.json)
          TAG_NAME="$PACKAGE-v$NEW_VERSION"

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

          echo ">>> Version bumped to: $NEW_VERSION"
          echo ">>> Tag name: $TAG_NAME"

      - name: Commit version change
        run: |
          echo ">>> Committing version change..."
          cd $PACKAGE_PATH

          git fetch origin
          git checkout develop
          git pull origin develop

          git add package.json
          git commit -m "chore($PACKAGE): release v$NEW_VERSION [$BUILD_MODE]"

      - name: Push to develop
        run: |
          echo ">>> Pushing to develop..."
          git push origin develop
          echo "IS_PUSHED=true" >> $GITHUB_ENV

      - name: Create and push tag
        run: |
          echo ">>> Creating tag: $TAG_NAME..."
          git tag -a "$TAG_NAME" -m "$PACKAGE_NAME v$NEW_VERSION"
          git push origin "$TAG_NAME"
          echo "IS_TAG_CREATED=true" >> $GITHUB_ENV

      - name: Merge to main (stable releases only)
        if: ${{ !startsWith(github.event.inputs.build_mode, 'pre') }}
        run: |
          echo ">>> Merging to main (stable release)..."
          git checkout main
          git pull origin main
          git merge develop --no-ff -m "chore: merge $PACKAGE v$NEW_VERSION to main"
          git push origin main
          echo "IS_MERGED=true" >> $GITHUB_ENV

      - name: Publish to NPM
        run: |
          cd $PACKAGE_PATH

          # Determine npm tag based on build mode
          case $BUILD_MODE in
            patch|minor|major)
              NPM_TAG="latest"
              ;;
            prepatch|preminor|premajor|prerelease)
              NPM_TAG="next"
              ;;
          esac

          echo ">>> Publishing to NPM with tag: $NPM_TAG..."
          npm publish --access public --tag $NPM_TAG

          echo "IS_PUBLISHED=true" >> $GITHUB_ENV
          echo "✓ Successfully published $PACKAGE_NAME@$NEW_VERSION"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      # =========================================================================
      # ROLLBACK (on failure)
      # =========================================================================
      - name: Rollback on failure
        if: failure()
        run: |
          echo "┌─────────────────────────────────────────────────"
          echo "│ ROLLBACK: Starting rollback process..."
          echo "└─────────────────────────────────────────────────"

          # Rollback tag
          if [ "$IS_TAG_CREATED" == "true" ]; then
            echo ">>> Deleting tag: $TAG_NAME"
            git push --delete origin "$TAG_NAME" 2>/dev/null || echo "    (tag not found on remote)"
            git tag -d "$TAG_NAME" 2>/dev/null || echo "    (tag not found locally)"
          fi

          # Rollback develop branch
          if [ "$IS_PUSHED" == "true" ]; then
            echo ">>> Resetting develop branch..."
            git checkout develop
            git reset --hard HEAD~1
            git push --force origin develop
          fi

          # Rollback main branch
          if [ "$IS_MERGED" == "true" ]; then
            echo ">>> Resetting main branch..."
            git checkout main
            git reset --hard HEAD~1
            git push --force origin main
          fi

          echo ""
          echo "┌─────────────────────────────────────────────────"
          echo "│ ROLLBACK COMPLETED"
          echo "│"
          if [ "$IS_PUBLISHED" == "true" ]; then
            echo "│ ⚠️  WARNING: Package was published to NPM!"
            echo "│ ⚠️  Run: npm deprecate $PACKAGE_NAME@$NEW_VERSION 'Accidental release'"
          fi
          echo "└─────────────────────────────────────────────────"
