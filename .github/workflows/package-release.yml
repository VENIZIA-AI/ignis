name: "NPM Release"
run-name: "NPM Release | package: ${{ inputs.package }} | build_mode: ${{ inputs.build_mode }}"

on:
  workflow_dispatch:
    inputs:
      package:
        type: choice
        description: Package to release
        options:
          - dev-configs
          - inversion
          - helpers
          - boot
          - core
          - docs
        required: true
      build_mode:
        type: choice
        description: "Version bump type (patch | minor | major | pre*)"
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
        required: true
        default: "patch"

# =============================================================================
# PACKAGE DEPENDENCY TREE:
#   dev-configs  → (none)
#   inversion    → dev-configs
#   helpers      → dev-configs, inversion
#   boot         → dev-configs, inversion, helpers
#   core         → dev-configs, inversion, helpers, boot
#   docs         → dev-configs
#
# SPECIAL CASES (dist directories):
#   - docs:      dist/mcp-server
#   - inversion: dist/cjs, dist/esm
#   - boot:      dist/cjs, dist/esm
#   - others:    dist
# =============================================================================

env:
  PACKAGE: ${{ github.event.inputs.package }}
  BUILD_MODE: ${{ github.event.inputs.build_mode }}

jobs:
  release:
    name: NPM Release
    runs-on: ubuntu-latest

    steps:
      # =========================================================================
      # SETUP
      # =========================================================================
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.3"

      - name: Setup Git
        run: |
          git config user.name "venizia-ci"
          git config user.email "developer@venizia.ai"

      # =========================================================================
      # PREPARE
      # =========================================================================
      - name: Get package info
        run: |
          PACKAGE_PATH="packages/$PACKAGE"
          PACKAGE_NAME=$(jq -r .name "$PACKAGE_PATH/package.json")
          CURRENT_VERSION=$(jq -r .version "$PACKAGE_PATH/package.json")

          # Set dist directories for validation
          case $PACKAGE in
            docs)            DIST_DIRS="dist/mcp-server" ;;
            inversion|boot)  DIST_DIRS="dist/cjs dist/esm" ;;
            *)               DIST_DIRS="dist" ;;
          esac

          echo "PACKAGE_PATH=$PACKAGE_PATH" >> $GITHUB_ENV
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "DIST_DIRS=$DIST_DIRS" >> $GITHUB_ENV

          echo "┌─────────────────────────────────────────────────"
          echo "│ Package:     $PACKAGE_NAME"
          echo "│ Path:        $PACKAGE_PATH"
          echo "│ Version:     $CURRENT_VERSION → $BUILD_MODE"
          echo "│ Dist:        $DIST_DIRS"
          echo "└─────────────────────────────────────────────────"

      - name: Install
        run: bun install

      - name: Force update package
        run: |
          case $BUILD_MODE in
            patch|minor|major) NPM_TAG="latest" ;;
            *)                 NPM_TAG="next" ;;
          esac
          bun run --filter "$PACKAGE_NAME" force-update "$NPM_TAG"

      # =========================================================================
      # BUILD, LINT & VALIDATE (uses Makefile dependency chain)
      # =========================================================================
      - name: Build
        run: make $PACKAGE

      - name: Lint
        run: make lint-$PACKAGE

      - name: Validate build artifacts
        run: |
          cd $PACKAGE_PATH
          for dir in $DIST_DIRS; do
            [ -f "$dir/index.js" ] && [ -f "$dir/index.d.ts" ] || { echo "ERROR: $dir missing files"; exit 1; }
            echo "    ✓ $dir"
          done

      # =========================================================================
      # VERSION & GIT
      # =========================================================================
      - name: Version bump
        run: |
          cd $PACKAGE_PATH
          npm version $BUILD_MODE --no-git-tag-version --workspaces-update=false

          NEW_VERSION=$(jq -r .version package.json)
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=$PACKAGE-v$NEW_VERSION" >> $GITHUB_ENV
          echo ">>> New version: $NEW_VERSION"

      - name: Commit & Push
        run: |
          cd $PACKAGE_PATH
          git fetch origin && git checkout develop && git pull origin develop
          git add package.json
          git commit -m "chore($PACKAGE): release v$NEW_VERSION [$BUILD_MODE]"
          git push origin develop
          echo "IS_PUSHED=true" >> $GITHUB_ENV

      - name: Create tag
        run: |
          git tag -a "$TAG_NAME" -m "$PACKAGE_NAME v$NEW_VERSION"
          git push origin "$TAG_NAME"
          echo "IS_TAG_CREATED=true" >> $GITHUB_ENV

      - name: Merge to main (stable only)
        if: ${{ !startsWith(github.event.inputs.build_mode, 'pre') }}
        run: |
          git checkout main && git pull origin main
          git merge develop --no-ff -m "chore: merge $PACKAGE v$NEW_VERSION to main"
          git push origin main
          echo "IS_MERGED=true" >> $GITHUB_ENV

      # =========================================================================
      # PUBLISH
      # =========================================================================
      - name: Publish to NPM
        run: |
          cd $PACKAGE_PATH

          case $BUILD_MODE in
            patch|minor|major) NPM_TAG="latest" ;;
            *)                 NPM_TAG="next" ;;
          esac

          # Skip prepublishOnly since we already built
          npm publish --access public --tag $NPM_TAG --ignore-scripts

          echo "IS_PUBLISHED=true" >> $GITHUB_ENV
          echo "✓ Published $PACKAGE_NAME@$NEW_VERSION ($NPM_TAG)"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      # =========================================================================
      # ROLLBACK
      # =========================================================================
      - name: Rollback on failure
        if: failure()
        run: |
          echo ">>> ROLLBACK STARTED"

          [ "$IS_TAG_CREATED" == "true" ] && {
            git push --delete origin "$TAG_NAME" 2>/dev/null || true
            git tag -d "$TAG_NAME" 2>/dev/null || true
          }

          [ "$IS_PUSHED" == "true" ] && {
            git checkout develop && git reset --hard HEAD~1 && git push --force origin develop
          }

          [ "$IS_MERGED" == "true" ] && {
            git checkout main && git reset --hard HEAD~1 && git push --force origin main
          }

          echo ">>> ROLLBACK COMPLETED"
          [ "$IS_PUBLISHED" == "true" ] && echo "⚠️  NPM package published - run: npm deprecate $PACKAGE_NAME@$NEW_VERSION 'Accidental release'"
