name: "[Package] NPM Release"

on:
  workflow_dispatch:
    inputs:
      package:
        type: choice
        description: Package to release
        options:
          - dev-configs
          - core
          - helpers
          - inversion
          - docs
        required: true
      build_mode:
        type: choice
        description: |
          Build Mode
          (patch | minor | major | pre<patch | minor | major | release>)
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
        required: true
        default: 'patch'

env:
  PACKAGE: ${{ github.event.inputs.package }}
  BUILD_MODE: ${{ github.event.inputs.build_mode }}

jobs:
  build-release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      - name: Setup Git
        run: |
          git config user.name "venizia-ci"
          git config user.email "ci@venizia.ai"

      - name: Get package info
        id: pkg_info
        run: |
          PACKAGE_PATH="packages/$PACKAGE"
          PACKAGE_NAME=$(jq -r .name "$PACKAGE_PATH/package.json")
          CURRENT_VERSION=$(jq -r .version "$PACKAGE_PATH/package.json")

          echo "package_path=$PACKAGE_PATH" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          echo "[pkg_info] Package: $PACKAGE_NAME"
          echo "[pkg_info] Path: $PACKAGE_PATH"
          echo "[pkg_info] Current version: $CURRENT_VERSION"

      - name: Verify build mode
        run: |
          echo "[verify] Package: ${{ steps.pkg_info.outputs.package_name }} | Build mode: $BUILD_MODE"

      - name: Install dependencies
        run: |
          echo "[install] Installing dependencies"
          bun install --frozen-lockfile

      - name: Clean previous build
        run: |
          echo "[clean] Cleaning previous build"
          bun run --filter "@venizia/$PACKAGE" clean || echo "[clean] No clean script found"

      - name: Build package
        run: |
          echo "[build] Building package"
          bun run --filter "@venizia/$PACKAGE" build

      - name: Validate build artifacts
        run: |
          cd ${{ steps.pkg_info.outputs.package_path }}

          if [ ! -d "dist" ]; then
            echo "[validate] Error: dist directory not found"
            exit 1
          fi

          if [ ! -f "dist/index.js" ]; then
            echo "[validate] Error: dist/index.js not found"
            exit 1
          fi

          if [ ! -f "dist/index.d.ts" ]; then
            echo "[validate] Error: dist/index.d.ts not found"
            exit 1
          fi

          echo "[validate] Build artifacts validated successfully"

      - name: Version bump
        id: version
        run: |
          cd ${{ steps.pkg_info.outputs.package_path }}

          case "$BUILD_MODE" in
            prepatch)
              npm version patch --no-git-tag-version
              ;;
            preminor)
              npm version minor --no-git-tag-version
              ;;
            premajor)
              npm version major --no-git-tag-version
              ;;
            prerelease)
              npm version patch --no-git-tag-version
              ;;
            *)
              npm version $BUILD_MODE --no-git-tag-version
              ;;
          esac

          NEW_VERSION=$(jq -r .version package.json)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$PACKAGE-v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "[version] New version: $NEW_VERSION"

      - name: Commit version change
        id: commit
        run: |
          cd ${{ steps.pkg_info.outputs.package_path }}
          VERSION="${{ steps.version.outputs.version }}"

          git fetch origin
          git checkout develop
          git pull origin develop

          git add package.json
          git commit -m "chore($PACKAGE): release v$VERSION [$BUILD_MODE]"

          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "[commit] Created commit: $COMMIT_SHA"

      - name: Push to develop
        id: push_develop
        run: |
          git push origin develop
          echo "[push_develop] Pushed to develop branch"
          echo "pushed=true" >> $GITHUB_OUTPUT

      - name: Create and push tag
        id: tag
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          VERSION="${{ steps.version.outputs.version }}"

          git tag -a "$TAG_NAME" -m "${{ steps.pkg_info.outputs.package_name }} v$VERSION"
          git push origin "$TAG_NAME"

          echo "[tag] Created and pushed tag: $TAG_NAME"
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Merge to main (stable releases only)
        id: merge_main
        if: ${{ !startsWith(env.BUILD_MODE, 'pre') }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git checkout main
          git pull origin main
          git merge develop --no-ff -m "chore: merge $PACKAGE v$VERSION to main"
          git push origin main

          echo "[merge_main] Merged to main branch"
          echo "merged=true" >> $GITHUB_OUTPUT

      - name: Publish to NPM
        id: publish
        run: |
          cd ${{ steps.pkg_info.outputs.package_path }}

          npm_tag=$(case $BUILD_MODE in
            patch|minor|major) echo "latest" ;;
            prepatch|preminor|premajor|prerelease) echo "next" ;;
          esac)

          echo "[publish] Publishing ${{ steps.pkg_info.outputs.package_name }}@${{ steps.version.outputs.version }} with tag: $npm_tag"
          npm publish --access public --tag $npm_tag

          echo "[publish] Successfully published to NPM"
          echo "npm_tag=$npm_tag" >> $GITHUB_OUTPUT
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      - name: Create GitHub Release
        id: github_release
        if: ${{ !startsWith(env.BUILD_MODE, 'pre') }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: "${{ steps.pkg_info.outputs.package_name }} v${{ steps.version.outputs.version }}"
          body: |
            ## ${{ steps.pkg_info.outputs.package_name }} v${{ steps.version.outputs.version }}

            ### Installation
            ```bash
            npm install ${{ steps.pkg_info.outputs.package_name }}@${{ steps.version.outputs.version }}
            # or
            bun add ${{ steps.pkg_info.outputs.package_name }}@${{ steps.version.outputs.version }}
            ```

            ### NPM Tags
            - Published under: `${{ steps.publish.outputs.npm_tag }}`

            ### Documentation
            Visit [Ignis Wiki](https://github.com/VENIZIA-AI/ignis/wiki) for usage documentation.
          draft: false
          prerelease: false

      - name: Rollback on failure
        if: failure()
        run: |
          echo "[rollback] Starting rollback process"
          cd ${{ steps.pkg_info.outputs.package_path }}

          # Delete tag if created
          if [ "${{ steps.tag.outputs.created }}" == "true" ]; then
            TAG_NAME="${{ steps.version.outputs.tag_name }}"
            git push --delete origin "$TAG_NAME" 2>/dev/null || echo "[rollback] Tag not found on remote"
            git tag -d "$TAG_NAME" 2>/dev/null || echo "[rollback] Tag not found locally"
            echo "[rollback] Deleted tag: $TAG_NAME"
          fi

          # Reset develop branch if pushed
          if [ "${{ steps.push_develop.outputs.pushed }}" == "true" ]; then
            git checkout develop
            git reset --hard HEAD~1
            git push --force origin develop
            echo "[rollback] Reset develop branch"
          fi

          # Reset main branch if merged
          if [ "${{ steps.merge_main.outputs.merged }}" == "true" ]; then
            git checkout main
            git reset --hard HEAD~1
            git push --force origin main
            echo "[rollback] Reset main branch"
          fi

          echo "[rollback] Rollback completed"
          echo "[rollback] Note: NPM packages cannot be unpublished automatically"
          if [ "${{ steps.publish.outputs.published }}" == "true" ]; then
            echo "[rollback] WARNING: Package was published to NPM as ${{ steps.pkg_info.outputs.package_name }}@${{ steps.version.outputs.version }}"
            echo "[rollback] You may need to deprecate it manually: npm deprecate ${{ steps.pkg_info.outputs.package_name }}@${{ steps.version.outputs.version }} 'Accidental release'"
          fi

  post-release:
    name: Post-release verification
    runs-on: ubuntu-latest
    needs: [build-release]
    if: success()

    steps:
      - name: Wait for NPM propagation
        run: |
          echo "[post-release] Waiting 30 seconds for NPM propagation"
          sleep 30

      - name: Verify package on NPM
        run: |
          PACKAGE_NAME="${{ needs.build-release.outputs.package_name || github.event.inputs.package }}"
          echo "[post-release] Verifying package on NPM registry"
          npm view @venizia/${{ github.event.inputs.package }} dist-tags || echo "[post-release] Package info not yet available"
          echo "[post-release] Release completed successfully"
